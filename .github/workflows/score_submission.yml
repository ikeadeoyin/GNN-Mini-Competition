name: Score Submission

on:
  pull_request:
    paths:
      - 'submissions/*.csv'

jobs:
  score:
    runs-on: ubuntu-latest

    permissions:
      contents: write          # needed to update leaderboard
      pull-requests: write     # needed to comment on PR

    steps:
    # 1. Checkout the student's code
    - uses: actions/checkout@v3

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install dependencies
    - name: Install dependencies
      run: |
        pip install -r starter_code/requirements.txt

  # 4. Restore the hidden ground truth from GitHub Secrets
    - name: Restore Ground Truth
      run: |
        # Write directly to the root folder as 'ground_truth.csv'
        echo "${{ secrets.GROUND_TRUTH_CSV }}" > ground_truth.csv

    # 5. Run the scoring script
    - name: Run scoring logic
      id: grade
      run: |
        SUBMISSION_FILE=$(find submissions -name "*.csv" ! -name "sample_submission.csv" | head -n 1)

        if [ -z "$SUBMISSION_FILE" ]; then
          echo "No submission file found!"
          exit 1
        fi

        echo "Found submission: $SUBMISSION_FILE"

        OUTPUT=$(python scoring_script.py "$SUBMISSION_FILE")

        echo "$OUTPUT"

        # Save full output for PR comment
        echo "SCORE_REPORT<<EOF" >> $GITHUB_ENV
        echo "$OUTPUT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        # Extract numeric score (expects e.g. 'Submission F1 Score: 0.7321')
        SCORE=$(echo "$OUTPUT" | grep -Eo '[0-9]+\.[0-9]+' | tail -n 1)
        echo "SCORE=$SCORE" >> $GITHUB_ENV

    # 6. Comment score on the Pull Request
    - name: Comment Score
      uses: actions/github-script@v6
      with:
        script: |
          const output = process.env.SCORE_REPORT;
          const score = process.env.SCORE;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `### ðŸ¤– Automated Grading Report\n\n**Score:** ${score}\n\n\`\`\`\n${output}\n\`\`\``
          });

    # 7. Update leaderboard
    - name: Update leaderboard
      run: |
        python update_leaderboard.py "${{ github.actor }}" "$SCORE"

    # 8. Commit leaderboard update
    - name: Commit leaderboard update
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add leaderboard.md
        git commit -m "Update leaderboard"
        git push
